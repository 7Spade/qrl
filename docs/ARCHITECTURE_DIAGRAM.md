# QRL 交易機器人架構圖

## 🏗️ 系統架構

### 完整系統架構

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Google Cloud Platform                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Cloud Scheduler                            │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │  │
│  │  │  Morning Job │  │   Noon Job   │  │ Evening Job  │       │  │
│  │  │   6:00 AM    │  │   12:00 PM   │  │   6:00 PM    │       │  │
│  │  │  (免費 #1)   │  │  (免費 #2)   │  │  (免費 #3)   │       │  │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │  │
│  └─────────┼──────────────────┼──────────────────┼──────────────┘  │
│            │                  │                  │                  │
│            │ HTTP POST        │ HTTP POST        │ HTTP POST        │
│            └──────────────────┴──────────────────┘                  │
│                               ↓                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Cloud Run Jobs                             │  │
│  │                                                                │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │           qrl-trading-job (Container)                  │  │  │
│  │  │  ┌──────────────────────────────────────────────────┐  │  │  │
│  │  │  │  1. 載入環境變數                                  │  │  │  │
│  │  │  │     - MEXC_API_KEY, MEXC_API_SECRET              │  │  │  │
│  │  │  │     - REDIS_URL, SYMBOL, etc.                    │  │  │  │
│  │  │  ├──────────────────────────────────────────────────┤  │  │  │
│  │  │  │  2. 初始化交易引擎 (TradingEngine)               │  │  │  │
│  │  │  │     - Exchange Client (MEXC)                     │  │  │  │
│  │  │  │     - State Manager (SQLite)                     │  │  │  │
│  │  │  │     - Risk Manager                               │  │  │  │
│  │  │  │     - EMA Strategy                               │  │  │  │
│  │  │  ├──────────────────────────────────────────────────┤  │  │  │
│  │  │  │  3. 執行交易週期                                  │  │  │  │
│  │  │  │     a. 獲取市場數據 (OHLCV)                      │  │  │  │
│  │  │  │     b. 策略分析 (EMA20/60)                       │  │  │  │
│  │  │  │     c. 風險檢查                                   │  │  │  │
│  │  │  │     d. 下單 (如符合條件)                         │  │  │  │
│  │  │  │     e. 更新狀態                                   │  │  │  │
│  │  │  ├──────────────────────────────────────────────────┤  │  │  │
│  │  │  │  4. 記錄日誌                                      │  │  │  │
│  │  │  │     → Cloud Logging                              │  │  │  │
│  │  │  ├──────────────────────────────────────────────────┤  │  │  │
│  │  │  │  5. 執行完成，容器關閉 (節省成本)               │  │  │  │
│  │  │  └──────────────────────────────────────────────────┘  │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                               │                                      │
│                               │ API Calls                            │
│                               ↓                                      │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ↓                       ↓                       ↓
┌───────────────┐      ┌────────────────┐     ┌────────────────┐
│  MEXC API     │      │  Redis Cache   │     │  Cloud Logging │
│               │      │                │     │                │
│  - Ticker     │      │  - TTL Cache   │     │  - Execution   │
│  - OHLCV      │      │  - Namespace   │     │  - Logs        │
│  - Orders     │      │  - Version     │     │  - Metrics     │
│  - Balance    │      │                │     │                │
└───────────────┘      └────────────────┘     └────────────────┘
```

## 🔄 執行流程

### 時序圖

```
時間軸 →

06:00 ─┐
       │  Cloud Scheduler (Morning)
       │     ↓
       │  觸發 Cloud Run Job
       │     ↓
       │  執行交易邏輯 (30-60秒)
       │     ↓
       └─ 完成，容器關閉
       
       ... (6小時等待) ...
       
12:00 ─┐
       │  Cloud Scheduler (Noon)
       │     ↓
       │  觸發 Cloud Run Job
       │     ↓
       │  執行交易邏輯 (30-60秒)
       │     ↓
       └─ 完成，容器關閉
       
       ... (6小時等待) ...
       
18:00 ─┐
       │  Cloud Scheduler (Evening)
       │     ↓
       │  觸發 Cloud Run Job
       │     ↓
       │  執行交易邏輯 (30-60秒)
       │     ↓
       └─ 完成，容器關閉
```

## 📊 數據流

### 交易決策流程

```
┌─────────────────┐
│  Cloud Scheduler│
│   定時觸發      │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  Cloud Run Job  │
│   啟動容器      │
└────────┬────────┘
         │
         ↓
┌──────────────────────────────────────────────┐
│              獲取市場數據                     │
│  ┌────────────────────────────────────────┐  │
│  │  Exchange Client → MEXC API            │  │
│  │  ↓                                      │  │
│  │  Redis Cache (檢查快取)                │  │
│  │  ↓                                      │  │
│  │  OHLCV 數據 (120 根 K 線)              │  │
│  └────────────────────────────────────────┘  │
└────────┬─────────────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────────────┐
│              策略分析                         │
│  ┌────────────────────────────────────────┐  │
│  │  計算 EMA20, EMA60                     │  │
│  │  ↓                                      │  │
│  │  檢查買入條件:                          │  │
│  │    1. 價格 ≤ EMA60 × 1.02              │  │
│  │    2. EMA20 ≥ EMA60                    │  │
│  │  ↓                                      │  │
│  │  生成信號: BUY or HOLD                 │  │
│  └────────────────────────────────────────┘  │
└────────┬─────────────────────────────────────┘
         │
         ├─ HOLD → 記錄日誌，結束
         │
         ↓ BUY
┌──────────────────────────────────────────────┐
│              風險檢查                         │
│  ┌────────────────────────────────────────┐  │
│  │  檢查當前持倉                           │  │
│  │  ↓                                      │  │
│  │  驗證:                                  │  │
│  │    - 持倉 + 訂單 ≤ 最大持倉            │  │
│  │    - 訂單大小合理                       │  │
│  │  ↓                                      │  │
│  │  通過: YES or NO                       │  │
│  └────────────────────────────────────────┘  │
└────────┬─────────────────────────────────────┘
         │
         ├─ NO → 記錄日誌，結束
         │
         ↓ YES
┌──────────────────────────────────────────────┐
│              下單執行                         │
│  ┌────────────────────────────────────────┐  │
│  │  獲取當前價格                           │  │
│  │  ↓                                      │  │
│  │  計算限價單價格 (市價 × 0.98)          │  │
│  │  ↓                                      │  │
│  │  計算購買數量                           │  │
│  │  ↓                                      │  │
│  │  提交限價買單 → MEXC                   │  │
│  │  ↓                                      │  │
│  │  訂單確認                               │  │
│  └────────────────────────────────────────┘  │
└────────┬─────────────────────────────────────┘
         │
         ↓
┌──────────────────────────────────────────────┐
│              更新狀態                         │
│  ┌────────────────────────────────────────┐  │
│  │  更新持倉總額 (SQLite)                 │  │
│  │  ↓                                      │  │
│  │  記錄交易歷史                           │  │
│  │  ↓                                      │  │
│  │  寫入 Cloud Logging                    │  │
│  └────────────────────────────────────────┘  │
└────────┬─────────────────────────────────────┘
         │
         ↓
┌─────────────────┐
│  執行完成        │
│  容器關閉        │
└─────────────────┘
```

## 🚀 部署架構

### Cloud Build 流程

```
開發者
  │
  │ git push / gcloud builds submit
  │
  ↓
┌────────────────────────────────────────┐
│         Cloud Build                     │
│  ┌──────────────────────────────────┐  │
│  │  Step 1: Build Docker Image      │  │
│  │    - FROM python:3.11-slim       │  │
│  │    - COPY requirements.txt       │  │
│  │    - RUN pip install             │  │
│  │    - COPY src/                   │  │
│  │    - CMD ["python", "main.py"]   │  │
│  └──────────────┬───────────────────┘  │
│                 ↓                       │
│  ┌──────────────────────────────────┐  │
│  │  Step 2: Push to Registry        │  │
│  │    gcr.io/PROJECT/qrl-bot-job    │  │
│  └──────────────┬───────────────────┘  │
│                 ↓                       │
│  ┌──────────────────────────────────┐  │
│  │  Step 3: Deploy to Cloud Run Jobs│  │
│  │    - Create/Update Job           │  │
│  │    - Set Environment Variables   │  │
│  │    - Configure VPC Connector     │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
                  │
                  ↓
┌────────────────────────────────────────┐
│     Cloud Run Job (Ready)              │
│     等待 Cloud Scheduler 觸發           │
└────────────────────────────────────────┘
```

## 💰 成本架構

### 費用組成

```
Cloud Scheduler (定時器)
├─ Job #1 (Morning)    → $0.00 (免費)
├─ Job #2 (Noon)       → $0.00 (免費)
└─ Job #3 (Evening)    → $0.00 (免費)
                         ──────────────
                         總計: $0.00/月

Cloud Run Jobs (執行)
├─ CPU Time
│  └─ ~30秒 × 3次/天 × 30天
│     = 2,700秒/月
│     = 45分鐘/月
│     ≈ $0.05/月
│
└─ Memory
   └─ 512MB × 45分鐘
      ≈ $0.015/月
                         ──────────────
                         總計: ~$0.065/月

總成本: ~$0.065/月 (約 NT$2)
```

## 🔐 安全架構

### 服務帳戶和權限

```
┌────────────────────────────────────────┐
│      Cloud Scheduler                    │
│  Service Account:                       │
│    PROJECT_ID@appspot.gserviceaccount  │
│  Permissions:                           │
│    - run.jobs.run                       │
└───────────┬────────────────────────────┘
            │ OAuth Token
            ↓
┌────────────────────────────────────────┐
│      Cloud Run Jobs                     │
│  Service Account:                       │
│    PROJECT_ID-compute@developer...     │
│  Permissions:                           │
│    - Storage access (logs)              │
│    - VPC access                         │
└───────────┬────────────────────────────┘
            │ API Keys (環境變數)
            ↓
┌────────────────────────────────────────┐
│      MEXC Exchange                      │
│  Authentication:                        │
│    - API Key (read-only recommended)   │
│    - API Secret                         │
└────────────────────────────────────────┘
```

### 環境變數管理

```
開發環境: .env 文件 (本地測試)
  │
  ↓
測試環境: Cloud Run Job 環境變數
  │
  ↓
生產環境: Secret Manager (推薦)
  └─ MEXC_API_KEY
  └─ MEXC_API_SECRET
  └─ REDIS_URL
```

## 📈 監控架構

### 日誌和監控流程

```
┌────────────────────────────────────────┐
│      Cloud Run Job                      │
│  ┌──────────────────────────────────┐  │
│  │  Python Logging                  │  │
│  │    - INFO: 一般訊息              │  │
│  │    - WARNING: 警告               │  │
│  │    - ERROR: 錯誤                 │  │
│  └───────────┬──────────────────────┘  │
└──────────────┼─────────────────────────┘
               │
               ↓
┌────────────────────────────────────────┐
│      Cloud Logging                      │
│  ┌──────────────────────────────────┐  │
│  │  日誌收集                         │  │
│  │    - Execution logs              │  │
│  │    - System logs                 │  │
│  │    - Error logs                  │  │
│  └───────────┬──────────────────────┘  │
└──────────────┼─────────────────────────┘
               │
               ↓
┌────────────────────────────────────────┐
│      Cloud Monitoring (可選)           │
│  ┌──────────────────────────────────┐  │
│  │  Metrics                         │  │
│  │    - Execution count             │  │
│  │    - Success rate                │  │
│  │    - Duration                    │  │
│  ├──────────────────────────────────┤  │
│  │  Alerts                          │  │
│  │    - Execution failures          │  │
│  │    - Long execution time         │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
               │
               ↓
           Email/SMS
        (告警通知)
```

## �� 策略執行架構

### 多時段執行策略

```
全球市場覆蓋:

┌─────────────────────────────────────────────────────────┐
│                      24小時時間軸                        │
├─────────────────────────────────────────────────────────┤
│ UTC:   00:00    06:00    12:00    18:00    24:00       │
│ 台北:  08:00    14:00    20:00    02:00    08:00       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ 06:00 (台北 14:00) ─┐                                   │
│   亞洲市場活躍      │ Job #1 執行                      │
│   ├─ 日本          └─→ 捕捉亞洲時段機會               │
│   ├─ 香港                                               │
│   └─ 新加坡                                             │
│                                                          │
│ 12:00 (台北 20:00) ─┐                                   │
│   歐洲市場開盤      │ Job #2 執行                      │
│   ├─ 倫敦          └─→ 捕捉歐洲時段機會               │
│   ├─ 法蘭克福                                           │
│   └─ 蘇黎世                                             │
│                                                          │
│ 18:00 (台北 02:00) ─┐                                   │
│   美國市場活躍      │ Job #3 執行                      │
│   ├─ 紐約          └─→ 捕捉美國時段機會               │
│   ├─ 芝加哥                                             │
│   └─ 舊金山                                             │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 📋 總結

### 關鍵優勢

1. **Serverless**: 無需管理伺服器
2. **成本優化**: 僅在執行時收費
3. **高可靠**: Google Cloud SLA
4. **易擴展**: 輕鬆調整執行頻率
5. **零維護**: 完全託管服務

### 技術棧

- **容器化**: Docker
- **編排**: Cloud Run Jobs
- **排程**: Cloud Scheduler
- **建置**: Cloud Build
- **日誌**: Cloud Logging
- **儲存**: Container Registry
- **語言**: Python 3.11
- **框架**: ccxt, pandas, ta

---

**架構完成！系統已準備好自動化交易。** 🚀
