# QRL 交易機器人 - Google Cloud Run 部署指南

## 概述

本指南介紹如何將 QRL 交易機器人部署到 Google Cloud Run，包括 Web 儀表板和定時交易執行。

## 架構

```
┌─────────────────────────────────────────┐
│   Google Cloud Run (Web 儀表板)         │
│   - FastAPI 應用程式                    │
│   - 即時價格監控                        │
│   - 倉位追蹤                            │
│   - 連接埠: 8080                        │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│   Cloud Scheduler (交易機器人)          │
│   - 定期執行 main.py                    │
│   - 執行交易邏輯                        │
│   - 更新 SQLite 資料庫                  │
└─────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│   Cloud Storage (持久化資料)            │
│   - SQLite 資料庫備份                   │
│   - 交易歷史記錄                        │
└─────────────────────────────────────────┘
```

## 前置需求

1. **Google Cloud 帳號**並啟用計費
2. **gcloud CLI** 已安裝並設定
3. **Docker** 已安裝（用於本地測試）
4. **MEXC API 金鑰**（交易和唯讀）

## 快速開始

### 1. 設定 Google Cloud 專案

```bash
# 設定你的專案 ID
export PROJECT_ID="your-project-id"
export REGION="asia-east1"

# 設定專案
gcloud config set project $PROJECT_ID

# 啟用所需的 API
gcloud services enable \
  cloudbuild.googleapis.com \
  run.googleapis.com \
  cloudscheduler.googleapis.com \
  secretmanager.googleapis.com
```

### 2. 在 Secret Manager 中儲存 API 金鑰

```bash
# 安全地儲存 MEXC API 憑證
echo -n "your-api-key" | gcloud secrets create mexc-api-key \
  --data-file=- \
  --replication-policy="automatic"

echo -n "your-api-secret" | gcloud secrets create mexc-api-secret \
  --data-file=- \
  --replication-policy="automatic"
```

### 3. 使用 Cloud Build 建置和部署

```bash
# 提交建置到 Cloud Build
gcloud builds submit --config cloudbuild.yaml

# 或手動建置和部署
docker build -t gcr.io/$PROJECT_ID/qrl-bot:latest .
docker push gcr.io/$PROJECT_ID/qrl-bot:latest

gcloud run deploy qrl-bot \
  --image gcr.io/$PROJECT_ID/qrl-bot:latest \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated \
  --set-secrets=MEXC_API_KEY=mexc-api-key:latest,MEXC_API_SECRET=mexc-api-secret:latest \
  --set-env-vars=SYMBOL=QRL/USDT
```

### 4. 設定 Cloud Scheduler 執行交易機器人

```bash
# 取得 Cloud Run 服務 URL
SERVICE_URL=$(gcloud run services describe qrl-bot \
  --platform managed \
  --region $REGION \
  --format 'value(status.url)')

# 建立 Cloud Scheduler 工作（每天早上 9 點執行，台北時間）
gcloud scheduler jobs create http qrl-bot-trader \
  --location=$REGION \
  --schedule="0 9 * * *" \
  --uri="$SERVICE_URL/trade" \
  --http-method=POST \
  --oidc-service-account-email=qrl-bot@$PROJECT_ID.iam.gserviceaccount.com \
  --time-zone="Asia/Taipei"
```

### 5. 存取你的儀表板

```bash
# 取得服務 URL
gcloud run services describe qrl-bot \
  --platform managed \
  --region $REGION \
  --format 'value(status.url)'
```

在瀏覽器中訪問該 URL 即可查看儀表板！

## 本地測試

### 使用 Docker 測試

```bash
# 建置映像檔
docker build -t qrl-bot .

# 執行 Web 儀表板
docker run -p 8080:8080 \
  -e MEXC_API_KEY="your-key" \
  -e MEXC_API_SECRET="your-secret" \
  qrl-bot

# 執行交易機器人（單次執行）
docker run \
  -e MEXC_API_KEY="your-key" \
  -e MEXC_API_SECRET="your-secret" \
  qrl-bot python main.py
```

### 使用 Docker Compose 測試

```bash
# 建立 .env 檔案並填入憑證
cp .env.example .env
# 編輯 .env 並加入你的 API 金鑰

# 啟動 Web 儀表板
docker-compose up qrl-bot-web

# 執行交易機器人（單次）
docker-compose run --rm qrl-bot-trader
```

## 設定

### 環境變數

| 變數 | 必填 | 預設值 | 說明 |
|------|------|--------|------|
| `MEXC_API_KEY` | 是 | - | MEXC API 金鑰 |
| `MEXC_API_SECRET` | 是 | - | MEXC API 密鑰 |
| `SYMBOL` | 否 | `QRL/USDT` | 交易對 |
| `PORT` | 否 | `8080` | Web 伺服器連接埠 |

### Cloud Run 設定

生產環境建議配置：

```bash
gcloud run deploy qrl-bot \
  --image gcr.io/$PROJECT_ID/qrl-bot:latest \
  --platform managed \
  --region asia-east1 \
  --memory 512Mi \
  --cpu 1 \
  --min-instances 0 \
  --max-instances 2 \
  --concurrency 80 \
  --timeout 300 \
  --allow-unauthenticated
```

## 持久化儲存

Cloud Run 是無狀態的。對於 SQLite 資料庫的持久化：

### 方案 1: Cloud Storage（建議）

```bash
# 建立儲存桶
gsutil mb gs://$PROJECT_ID-qrl-data

# 在 Cloud Run 中掛載（需要 Cloud Run with Cloud Storage）
# 在部署中加入 volume mount
```

### 方案 2: Cloud SQL

生產級持久化：

```bash
# 建立 Cloud SQL 實例
gcloud sql instances create qrl-db \
  --database-version=POSTGRES_15 \
  --tier=db-f1-micro \
  --region=$REGION

# 更新代碼使用 PostgreSQL 而非 SQLite
```

## 監控

### 查看日誌

```bash
# 查看 Cloud Run 日誌
gcloud run logs read qrl-bot --region=$REGION

# 即時查看日誌
gcloud run logs tail qrl-bot --region=$REGION
```

### 設定告警

```bash
# 建立錯誤告警
gcloud alpha monitoring policies create \
  --notification-channels=CHANNEL_ID \
  --display-name="QRL Bot 錯誤" \
  --condition-display-name="錯誤率過高" \
  --condition-threshold-value=0.1 \
  --condition-threshold-duration=60s
```

## 成本優化

1. **使用最小資源**: 儀表板使用 256Mi RAM, 0.5 CPU
2. **設定最小實例為 0**: 只在執行時付費
3. **謹慎使用 Cloud Scheduler**: 限制交易頻率
4. **監控 API 呼叫**: MEXC 有速率限制

**預估月費用:**
- Cloud Run: $0-5（大部分在免費額度內）
- Cloud Scheduler: $0.10/工作
- Cloud Build: $0（每天 120 次建置免費）
- Secret Manager: 每個密鑰 $0.06
- **總計: 約 $1-10/月**

## 安全性最佳實踐

1. ✅ 使用 Secret Manager 儲存 API 金鑰
2. ✅ 啟用 Cloud Armor 防止 DDoS 攻擊
3. ✅ 使用 VPC Service Controls
4. ✅ 啟用審計日誌
5. ✅ 儀表板使用唯讀 API 金鑰
6. ✅ 實作速率限制
7. ✅ 定期安全掃描

## 疑難排解

### 容器啟動失敗

```bash
# 檢查日誌
gcloud run logs read qrl-bot --limit=50

# 先在本地測試
docker run -p 8080:8080 qrl-bot
```

### 資料庫錯誤

```bash
# 確保 data 目錄存在
# 檢查檔案權限
# 驗證 SQLite 相容性
```

### API 認證失敗

```bash
# 驗證密鑰
gcloud secrets versions access latest --secret=mexc-api-key

# 在本地測試 API 金鑰
python -c "from exchange import get_exchange; print(get_exchange().fetch_ticker('QRL/USDT'))"
```

## 進階: CI/CD 管線

### Git Push 自動部署

```bash
# 連接儲存庫到 Cloud Build
gcloud builds triggers create github \
  --repo-name=qrl \
  --repo-owner=7Spade \
  --branch-pattern="^main$" \
  --build-config=cloudbuild.yaml
```

### 多環境設定

```bash
# 部署到測試環境
gcloud run deploy qrl-bot-staging \
  --image gcr.io/$PROJECT_ID/qrl-bot:$VERSION \
  --region=$REGION

# 部署到生產環境
gcloud run deploy qrl-bot-prod \
  --image gcr.io/$PROJECT_ID/qrl-bot:$VERSION \
  --region=$REGION
```

## 清理資源

```bash
# 刪除 Cloud Run 服務
gcloud run services delete qrl-bot --region=$REGION

# 刪除 Cloud Scheduler 工作
gcloud scheduler jobs delete qrl-bot-trader --location=$REGION

# 刪除密鑰
gcloud secrets delete mexc-api-key
gcloud secrets delete mexc-api-secret

# 刪除容器映像檔
gcloud container images delete gcr.io/$PROJECT_ID/qrl-bot
```

## 支援

- [Google Cloud Run 文檔](https://cloud.google.com/run/docs)
- [Cloud Build 文檔](https://cloud.google.com/build/docs)
- [QRL Bot Issues](https://github.com/7Spade/qrl/issues)

---

**注意**: 在使用真實資金部署到生產環境之前，務必在開發環境中進行充分測試。
